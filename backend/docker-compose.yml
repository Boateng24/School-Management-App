version: "3.7"
services:
    web:
        build:
            context: .
            dockerfile: Dockerfile.dev
        container_name: schoolmanagement
        image: schoolmanagement:latest
        ports:
            - 5000:5000
        environment:
            DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
            PORT_NUMBER: 5000
        depends_on:
            - prisma-postgres-api
            - postgres
        command: ["sh", "-c", "npm install -g prisma && sh entrypoint.sh && npm run start"]
        volumes:
            - type: bind
              source: .
              target: /usr/app
              read_only: true
              bind:
                  propagation: "rshared"

    prisma-postgres-api:
        stdin_open: true
        build:
            context: .
            dockerfile: Dockerfile.dev
        container_name: prisma-postgres-api
        ports:
            - "4466:4466"
        environment:
            PRISMA_CONFIG: |
                port: 4466
                host: postgres
                databases:
                  default:
                    connector: postgres
            DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB}
            PORT_NUMBER: 5000
            migrations:
            path: prisma/migrations
            provider: postgresql
            enabled: true
        depends_on:
            - postgres
        volumes:
            - prisma_data:/app/prisma/data 
        restart: always

    postgres:
        image: postgres
        container_name: postgres
        ports:
            - "5432:5432"
        environment:
            - POSTGRES_USER=${POSTGRES_USER}
            - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
            - POSTGRES_DB=${POSTGRES_DB}
        volumes:
            - postgres_data:/var/lib/postgresql/data

volumes:
    postgres_data:
    prisma_data:
